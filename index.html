<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantumTrader | AI Stock Market Game</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap');
        
        :root {
            --quantum-blue: #0a0a2a;
            --neon-teal: #00ffcc;
            --neon-purple: #cc00ff;
            --text-glow: 0 0 10px var(--neon-teal);
            --card-width: 180px;
        }
        
        body {
            margin: 0;
            padding: 0;
            background-color: var(--quantum-blue);
            color: white;
            font-family: 'Rajdhani', sans-serif;
            overflow-x: hidden;
            height: 100vh;
        }
        
        .container {
            display: grid;
            grid-template-rows: auto auto 1fr;
            height: 100%;
        }
        
        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--neon-teal);
            box-shadow: 0 0 15px var(--neon-teal);
        }
        
        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--neon-teal);
            text-shadow: var(--text-glow);
            letter-spacing: 2px;
        }
        
        .profile-btn {
            background: rgba(10, 10, 42, 0.7);
            border: 1px solid var(--neon-teal);
            color: white;
            padding: 0.5rem 1rem;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .profile-btn:hover {
            background: var(--neon-teal);
            color: var(--quantum-blue);
            text-shadow: none;
            box-shadow: 0 0 15px var(--neon-teal);
        }
        
        /* Search Bar Styles */
        .search-container {
            padding: 1rem 2rem;
            position: relative;
        }
        
        .search-bar {
            width: 100%;
            padding: 0.8rem 1rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--neon-teal);
            border-radius: 4px;
            color: white;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.2);
        }
        
        .search-bar::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 2rem;
            right: 2rem;
            max-height: 300px;
            overflow-y: auto;
            background: var(--quantum-blue);
            border: 1px solid var(--neon-teal);
            border-top: none;
            z-index: 10;
            display: none;
        }
        
        .search-result-item {
            padding: 0.8rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .search-result-item:hover {
            background: rgba(0, 255, 204, 0.1);
        }
        
        /* Market Overview Section */
        .market-overview {
            padding: 1rem 0;
            position: relative;
        }
        
        .section-title {
            text-align: center;
            font-family: 'Orbitron', sans-serif;
            color: var(--neon-teal);
            margin: 1rem 0;
            text-shadow: var(--text-glow);
            font-size: 1.5rem;
        }
        
        /* Scroller Container - FIXED SCROLLING */
        .scroller-container {
            position: relative;
            width: 100%;
            margin: 0 auto;
            overflow: hidden;
        }
        
        .scroller {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            padding: 0 2rem;
            gap: 1.5rem;
            height: 250px;
        }
        
        .scroller-inner {
            display: flex;
            gap: 1.5rem;
            height: 100%;
        }
        
        .scroller::-webkit-scrollbar {
            height: 8px;
        }
        
        .scroller::-webkit-scrollbar-track {
            background: rgba(0, 255, 204, 0.1);
            border-radius: 4px;
        }
        
        .scroller::-webkit-scrollbar-thumb {
            background: var(--neon-teal);
            border-radius: 4px;
        }
        
        /* Navigation Arrows */
        .scroll-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--neon-teal);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 5;
            opacity: 0.7;
            transition: all 0.3s;
        }
        
        .scroll-arrow:hover {
            opacity: 1;
            background: rgba(0, 255, 204, 0.2);
            box-shadow: 0 0 10px var(--neon-teal);
        }
        
        .scroll-arrow.left {
            left: 10px;
        }
        
        .scroll-arrow.right {
            right: 10px;
        }
        
        /* Stock Card */
        .stock-card {
            flex: 0 0 var(--card-width);
            height: 220px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--neon-teal);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            box-shadow: 0 0 15px rgba(0, 255, 204, 0.3);
            scroll-snap-align: start;
        }
        
        .stock-card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 0 25px var(--neon-teal);
        }
        
        .stock-logo-3d {
            width: 100px;
            height: 100px;
            background: rgba(0, 255, 204, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            border: 1px solid var(--neon-teal);
            box-shadow: 0 0 15px rgba(0, 255, 204, 0.3);
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
        }
        
        .stock-name {
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: white;
            text-align: center;
        }
        
        .stock-price {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
        }
        
        .price-up {
            color: #00ff88;
            text-shadow: 0 0 10px #00ff88;
        }
        
        .price-down {
            color: #ff0066;
            text-shadow: 0 0 10px #ff0066;
        }
        
        /* AI Analysis Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100;
            overflow-y: auto;
        }
        
        .modal-content {
            background: var(--quantum-blue);
            margin: 2rem auto;
            padding: 2rem;
            max-width: 800px;
            border: 1px solid var(--neon-purple);
            box-shadow: 0 0 30px var(--neon-purple);
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .company-header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .modal-logo {
            width: 80px;
            height: 80px;
            margin-right: 1.5rem;
        }
        
        .company-info h2 {
            margin: 0;
            color: var(--neon-teal);
            font-family: 'Orbitron', sans-serif;
        }
        
        .current-price {
            font-size: 1.5rem;
            margin: 0.5rem 0;
        }
        
        .ai-analysis {
            margin: 2rem 0;
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.3);
            border-left: 3px solid var(--neon-purple);
        }
        
        .ai-title {
            color: var(--neon-purple);
            font-family: 'Orbitron', sans-serif;
            margin-top: 0;
        }
        
        .buy-recommendation {
            text-align: center;
            margin: 3rem 0;
            padding: 2rem;
            border-top: 1px solid var(--neon-teal);
            border-bottom: 1px solid var(--neon-teal);
        }
        
        .buy-question {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            color: white;
            margin-bottom: 1.5rem;
        }
        
        .buy-answer {
            font-size: 1.5rem;
            font-weight: bold;
            padding: 1rem 2rem;
            border-radius: 5px;
            display: inline-block;
        }
        
        .buy-yes {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            border: 1px solid #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
        }
        
        .buy-no {
            background: rgba(255, 0, 102, 0.2);
            color: #ff0066;
            border: 1px solid #ff0066;
            box-shadow: 0 0 20px rgba(255, 0, 102, 0.5);
        }
        
        /* Grid Background */
        .grid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(rgba(0, 255, 204, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 204, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            pointer-events: none;
            z-index: -1;
        }
        
        /* Data Connection Status */
        .connection-status {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid var(--neon-teal);
            border-radius: 5px;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
        }
        
        .connected {
            color: #00ff88;
            text-shadow: 0 0 5px #00ff88;
        }
        
        .disconnected {
            color: #ff0066;
            text-shadow: 0 0 5px #ff0066;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--neon-teal);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="grid-overlay"></div>
    <div class="container">
        <header class="header">
            <div class="logo">QUANTUMTRADER</div>
            <button class="profile-btn">PROFILE</button>
        </header>
        
        <!-- Search Bar -->
        <div class="search-container">
            <input type="text" class="search-bar" placeholder="Search for stocks..." id="stockSearch">
            <div class="search-results" id="searchResults"></div>
        </div>
        
        <main class="market-overview">
            <h2 class="section-title">MARKET OVERVIEW</h2>
            
            <!-- Horizontal Scroller with Fixed Layout -->
            <div class="scroller-container">
                <div class="scroll-arrow left" onclick="scrollStocks(-1)">←</div>
                <div class="scroller" id="stockScroller">
                    <div class="scroller-inner" id="stockContainer">
                        <!-- Stock cards will be loaded here dynamically -->
                    </div>
                </div>
                <div class="scroll-arrow right" onclick="scrollStocks(1)">→</div>
            </div>
        </main>
    </div>
    
    <!-- AI Analysis Modal -->
    <div id="analysisModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">×</button>
            
            <div class="company-header">
                <div class="modal-logo" id="modalLogo"></div>
                <div class="company-info">
                    <h2 id="companyName">COMPANY NAME</h2>
                    <div class="current-price" id="currentPrice">$0.00 (0.00%)</div>
                </div>
            </div>
            
            <div class="ai-analysis">
                <h3 class="ai-title">QUANTUM AI ANALYSIS</h3>
                <p id="aiSummary">Loading quantum analysis... Our AI is currently evaluating market trends, recent news, technical indicators, and fundamental data to provide you with the most accurate assessment.</p>
                
                <h4>KEY METRICS</h4>
                <ul id="keyMetrics">
                    <li>Loading financial data...</li>
                </ul>
                
                <h4>RECENT NEWS SENTIMENT</h4>
                <p id="newsSentiment">Analyzing latest headlines...</p>
                
                <h4>REAL-TIME DATA STATUS</h4>
                <p id="dataStatus">Connecting to market data API...</p>
                
                <div id="aiPredictionContainer">
                    <h4>AI PREDICTION ANALYSIS</h4>
                    <div id="aiPrediction">
                        <div class="spinner"></div>
                        <p>Processing AI prediction...</p>
                    </div>
                </div>
            </div>
            
            <div class="buy-recommendation">
                <div class="buy-question">SHOULD I BUY THIS STOCK?</div>
                <div class="buy-answer" id="buyRecommendation">QUANTUM AI PROCESSING...</div>
            </div>
        </div>
    </div>
    
    <div id="connectionStatus" class="connection-status disconnected">
        DATA: DISCONNECTED
    </div>
    
    <script>
        // API Configuration
        const polygonApiKey = 'rQHFtCLRHMTCMNfShJwNVHKgc2PxACWG';
        const finnhubApiKey = 'd0uelbpr01qn5fk4u25gd0uelbpr01qn5fk4u260';
        const aimlApiKey = '579590888fcc4c8fb7f6bbdccf1de182';
        
        // Tracked stocks with their full names
        const trackedStocks = {
            'AAPL': 'Apple Inc.',
            'MSFT': 'Microsoft Corporation',
            'GOOGL': 'Alphabet Inc.',
            'AMZN': 'Amazon.com Inc.',
            'TSLA': 'Tesla Inc.',
            'NVDA': 'NVIDIA Corporation',
            'META': 'Meta Platforms Inc.',
            'JPM': 'JPMorgan Chase & Co.',
            'BAC': 'Bank of America Corporation',
            'DIS': 'The Walt Disney Company',
            'V': 'Visa Inc.',
            'JNJ': 'Johnson & Johnson',
            'WMT': 'Walmart Inc.',
            'PG': 'Procter & Gamble',
            'MA': 'Mastercard Incorporated',
            'HD': 'Home Depot Inc.',
            'VZ': 'Verizon Communications',
            'KO': 'Coca-Cola Company',
            'PEP': 'PepsiCo Inc.',
            'NFLX': 'Netflix Inc.',
            'ADBE': 'Adobe Inc.'
        };

        const stockElements = {};
        let socket;
        let connectionStatus = document.getElementById('connectionStatus');
        let currentDataSource = 'polygon';
        
        // Initialize the application
        async function init() {
            // First try to connect to Polygon
            try {
                await connectToPolygon();
                currentDataSource = 'polygon';
                connectionStatus.textContent = "DATA: CONNECTED (Polygon.io)";
                connectionStatus.classList.remove('disconnected');
                connectionStatus.classList.add('connected');
            } catch (polygonError) {
                console.error('Polygon connection failed, falling back to Finnhub:', polygonError);
                // Fall back to Finnhub if Polygon fails
                try {
                    await connectToFinnhub();
                    currentDataSource = 'finnhub';
                    connectionStatus.textContent = "DATA: CONNECTED (Finnhub API)";
                    connectionStatus.classList.remove('disconnected');
                    connectionStatus.classList.add('connected');
                } catch (finnhubError) {
                    console.error('Finnhub connection failed:', finnhubError);
                    connectionStatus.textContent = "DATA: DISCONNECTED";
                    connectionStatus.classList.remove('connected');
                    connectionStatus.classList.add('disconnected');
                }
            }
            
            // Load all stock cards
            loadStockCards();
            
            // Initialize search functionality
            initSearch();
            
            // Initialize scrolling
            initScrollerNavigation();
        }
        
        // Connect to Polygon.io WebSocket
        async function connectToPolygon() {
            return new Promise((resolve, reject) => {
                socket = new WebSocket(`wss://socket.polygon.io/stocks`);
                
                socket.onopen = function() {
                    console.log('Polygon WebSocket connected');
                    // Authenticate
                    socket.send(JSON.stringify({
                        "action": "auth",
                        "params": polygonApiKey
                    }));
                    
                    // Subscribe to all our tracked stocks
                    const tickers = Object.keys(trackedStocks);
                    const subscriptions = tickers.map(t => `A.${t}`).concat(tickers.map(t => `AM.${t}`));
                    
                    socket.send(JSON.stringify({
                        "action": "subscribe",
                        "params": subscriptions.join(',')
                    }));
                    
                    resolve();
                };
                
                socket.onclose = function() {
                    console.log('Polygon WebSocket disconnected');
                    reject('Polygon connection closed');
                };
                
                socket.onerror = function(error) {
                    console.error('Polygon WebSocket error:', error);
                    reject(error);
                };
                
                socket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    
                    // Process real-time trade data
                    if (data.length > 0) {
                        data.forEach(item => {
                            if (item.ev === 'A' || item.ev === 'AM') { // Aggregates or Aggregates per Minute
                                const ticker = item.symbol;
                                if (trackedStocks[ticker]) {
                                    updateStockCard(ticker, item.c, item.o);
                                }
                            }
                        });
                    }
                };
            });
        }
        
        // Connect to Finnhub WebSocket (fallback)
        async function connectToFinnhub() {
            return new Promise((resolve, reject) => {
                socket = new WebSocket(`wss://ws.finnhub.io?token=${finnhubApiKey}`);
                
                socket.onopen = function() {
                    console.log('Finnhub WebSocket connected');
                    
                    // Subscribe to each stock's real-time updates
                    Object.keys(trackedStocks).forEach(ticker => {
                        socket.send(JSON.stringify({'type':'subscribe', 'symbol': ticker}));
                    });
                    
                    // Fetch initial prices for all stocks
                    fetchInitialPrices();
                    resolve();
                };
                
                socket.onclose = function() {
                    console.log('Finnhub WebSocket disconnected');
                    reject('Finnhub connection closed');
                };
                
                socket.onerror = function(error) {
                    console.error('Finnhub WebSocket error:', error);
                    reject(error);
                };
                
                socket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'trade') {
                        // Process real-time trade data
                        data.data.forEach(trade => {
                            const ticker = trade.s;
                            if (trackedStocks[ticker]) {
                                updateStockCard(ticker, trade.p);
                            }
                        });
                    }
                };
            });
        }
        
        // Load all stock cards into the DOM
        function loadStockCards() {
            const stockContainer = document.getElementById('stockContainer');
            stockContainer.innerHTML = '';
            
            Object.keys(trackedStocks).forEach(ticker => {
                const stockCard = document.createElement('div');
                stockCard.className = 'stock-card';
                stockCard.onclick = () => openModal(ticker);
                stockCard.innerHTML = `
                    <div class="stock-logo-3d">${ticker}</div>
                    <h3 class="stock-name">${trackedStocks[ticker]}</h3>
                    <div class="stock-price">Loading...</div>
                `;
                
                stockContainer.appendChild(stockCard);
                
                // Store reference to the card elements
                stockElements[ticker] = {
                    card: stockCard,
                    priceElement: stockCard.querySelector('.stock-price'),
                    nameElement: stockCard.querySelector('.stock-name'),
                    logoElement: stockCard.querySelector('.stock-logo-3d')
                };
                
                // Fetch initial price data
                fetchStockPrice(ticker);
            });
        }
        
        // Fetch initial prices for all stocks
        async function fetchInitialPrices() {
            for (const ticker of Object.keys(trackedStocks)) {
                await fetchStockPrice(ticker);
            }
        }
        
        // Fetch stock price from the appropriate API
        async function fetchStockPrice(ticker) {
            try {
                let currentPrice, previousClose;
                
                if (currentDataSource === 'polygon') {
                    // Try Polygon first
                    const response = await fetch(`https://api.polygon.io/v2/aggs/ticker/${ticker}/prev?adjusted=true&apiKey=${polygonApiKey}`);
                    const data = await response.json();
                    
                    if (data.results && data.results.length > 0) {
                        currentPrice = data.results[0].c;
                        previousClose = data.results[0].o;
                    } else {
                        throw new Error('No data from Polygon');
                    }
                } else {
                    // Fall back to Finnhub
                    const response = await fetch(`https://finnhub.io/api/v1/quote?symbol=${ticker}&token=${finnhubApiKey}`);
                    const data = await response.json();
                    
                    if (data.c && data.pc) {
                        currentPrice = data.c;
                        previousClose = data.pc;
                    } else {
                        throw new Error('No data from Finnhub');
                    }
                }
                
                updateStockCard(ticker, currentPrice, previousClose);
            } catch (error) {
                console.error(`Error fetching price for ${ticker}:`, error);
                stockElements[ticker].priceElement.textContent = 'Data Unavailable';
            }
        }
        
        // Function to update stock card with real-time data
        function updateStockCard(ticker, currentPrice, previousClose) {
            const stock = stockElements[ticker];
            if (!stock) return;
            
            // Calculate change if we have previous close
            if (previousClose !== undefined) {
                const change = currentPrice - previousClose;
                const percentChange = (change / previousClose * 100).toFixed(2);
                
                stock.card.dataset.currentPrice = currentPrice;
                stock.card.dataset.previousClose = previousClose;
                stock.card.dataset.percentChange = percentChange;
                
                // Update the DOM
                stock.priceElement.innerHTML = `$${currentPrice.toFixed(2)} `;
                
                if (change >= 0) {
                    stock.priceElement.innerHTML += `<span class="price-up">(+${percentChange}%)</span>`;
                } else {
                    stock.priceElement.innerHTML += `<span class="price-down">(${percentChange}%)</span>`;
                }
            } else {
                // Just show current price if we don't have change data
                stock.priceElement.textContent = `$${currentPrice.toFixed(2)}`;
                stock.card.dataset.currentPrice = currentPrice;
            }
        }
        
        // Initialize search functionality
        function initSearch() {
            const searchInput = document.getElementById('stockSearch');
            const searchResults = document.getElementById('searchResults');
            
            searchInput.addEventListener('input', async (e) => {
                const query = e.target.value.trim().toUpperCase();
                
                if (query.length < 1) {
                    searchResults.style.display = 'none';
                    return;
                }
                
                // First check our tracked stocks
                const localMatches = Object.keys(trackedStocks).filter(ticker => 
                    ticker.includes(query) || trackedStocks[ticker].toUpperCase().includes(query)
                );
                
                // Display local matches immediately
                if (localMatches.length > 0) {
                    searchResults.innerHTML = localMatches.map(ticker => `
                        <div class="search-result-item" onclick="handleSearchSelect('${ticker}')">
                            <strong>${ticker}</strong> - ${trackedStocks[ticker]}
                        </div>
                    `).join('');
                    searchResults.style.display = 'block';
                } else {
                    searchResults.innerHTML = '<div class="search-result-item">No matches found</div>';
                    searchResults.style.display = 'block';
                }
            });
            
            // Hide results when clicking outside
            document.addEventListener('click', (e) => {
                if (e.target !== searchInput) {
                    searchResults.style.display = 'none';
                }
            });
        }
        
        // Handle selection from search results
        function handleSearchSelect(ticker) {
            // Close search results
            document.getElementById('searchResults').style.display = 'none';
            
            // Scroll to the selected stock if we have it
            if (stockElements[ticker]) {
                const card = stockElements[ticker].card;
                const scroller = document.getElementById('stockScroller');
                
                // Calculate scroll position to center the card
                const scrollLeft = card.offsetLeft - (scroller.offsetWidth / 2) + (card.offsetWidth / 2);
                scroller.scrollTo({
                    left: scrollLeft,
                    behavior: 'smooth'
                });
                
                // Add highlight effect
                card.style.boxShadow = '0 0 25px var(--neon-purple)';
                setTimeout(() => {
                    card.style.boxShadow = '0 0 15px rgba(0, 255, 204, 0.3)';
                }, 2000);
            } else {
                // If it's not in our tracked stocks, open modal directly
                openModal(ticker);
            }
        }
        
        // Initialize horizontal scrolling with arrow key navigation
        function initScrollerNavigation() {
            const scroller = document.getElementById('stockScroller');
            
            // Enable arrow key navigation
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') {
                    scroller.scrollBy({ left: -300, behavior: 'smooth' });
                } else if (e.key === 'ArrowRight') {
                    scroller.scrollBy({ left: 300, behavior: 'smooth' });
                }
            });
            
            // Add touch/swipe support
            let isDown = false;
            let startX;
            let scrollLeft;
            
            scroller.addEventListener('mousedown', (e) => {
                isDown = true;
                startX = e.pageX - scroller.offsetLeft;
                scrollLeft = scroller.scrollLeft;
                scroller.style.cursor = 'grabbing';
            });
            
            scroller.addEventListener('mouseleave', () => {
                isDown = false;
                scroller.style.cursor = 'grab';
            });
            
            scroller.addEventListener('mouseup', () => {
                isDown = false;
                scroller.style.cursor = 'grab';
            });
            
            scroller.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - scroller.offsetLeft;
                const walk = (x - startX) * 2;
                scroller.scrollLeft = scrollLeft - walk;
            });
            
            // Touch events for mobile
            scroller.addEventListener('touchstart', (e) => {
                isDown = true;
                startX = e.touches[0].pageX - scroller.offsetLeft;
                scrollLeft = scroller.scrollLeft;
            });
            
            scroller.addEventListener('touchend', () => {
                isDown = false;
            });
            
            scroller.addEventListener('touchmove', (e) => {
                if (!isDown) return;
                const x = e.touches[0].pageX - scroller.offsetLeft;
                const walk = (x - startX) * 2;
                scroller.scrollLeft = scrollLeft - walk;
            });
        }
        
        // Scroll stocks with arrow buttons
        function scrollStocks(direction) {
            const scroller = document.getElementById('stockScroller');
            scroller.scrollBy({ left: direction * 300, behavior: 'smooth' });
        }
        
        // Get AI prediction from aimlapi.com
        async function getAIPrediction(ticker) {
            try {
                const response = await fetch('https://aimlapi.com/app/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${aimlApiKey}`
                    },
                    body: JSON.stringify({
                        ticker: ticker,
                        data: {
                            currentPrice: document.getElementById('currentPrice').textContent,
                            metrics: document.getElementById('keyMetrics').innerHTML,
                            newsSentiment: document.getElementById('newsSentiment').textContent
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`AI API error: ${response.status}`);
                }
                
                const data = await response.json();
                return data.prediction || "AI analysis unavailable";
            } catch (error) {
                console.error('Error getting AI prediction:', error);
                return "Error loading AI prediction";
            }
        }
        
        // Enhanced modal with real-time data
        async function openModal(ticker) {
            const modal = document.getElementById('analysisModal');
            
            // Show loading state
            document.getElementById('modalLogo').textContent = ticker;
            document.getElementById('companyName').textContent = trackedStocks[ticker] || ticker;
            document.getElementById('currentPrice').textContent = 'Loading price data...';
            document.getElementById('aiSummary').textContent = 'Loading quantum analysis...';
            document.getElementById('aiPrediction').innerHTML = '<div class="spinner"></div><p>Processing AI prediction...</p>';
            
            try {
                let profileData, quoteData, metricsData, newsData;
                
                if (currentDataSource === 'polygon') {
                    // Try to fetch from Polygon first
                    const [tickerDetailsRes, prevCloseRes] = await Promise.all([
                        fetch(`https://api.polygon.io/v3/reference/tickers/${ticker}?apiKey=${polygonApiKey}`),
                        fetch(`https://api.polygon.io/v2/aggs/ticker/${ticker}/prev?adjusted=true&apiKey=${polygonApiKey}`)
                    ]);
                    
                    const tickerDetails = await tickerDetailsRes.json();
                    const prevClose = await prevCloseRes.json();
                    
                    profileData = {
                        name: tickerDetails.results?.name || trackedStocks[ticker] || ticker,
                        marketCapitalization: tickerDetails.results?.market_cap || 0
                    };
                    
                    if (prevClose.results && prevClose.results.length > 0) {
                        quoteData = {
                            c: prevClose.results[0].c,
                            pc: prevClose.results[0].o
                        };
                    } else {
                        throw new Error('No price data from Polygon');
                    }
                    
                    // For Polygon, we might need additional endpoints for metrics and news
                    metricsData = { metric: {} };
                    newsData = [];
                } else {
                    // Fall back to Finnhub
                    const [profileResponse, quoteResponse, metricsResponse, newsResponse] = await Promise.all([
                        fetch(`https://finnhub.io/api/v1/stock/profile2?symbol=${ticker}&token=${finnhubApiKey}`),
                        fetch(`https://finnhub.io/api/v1/quote?symbol=${ticker}&token=${finnhubApiKey}`),
                        fetch(`https://finnhub.io/api/v1/stock/metric?symbol=${ticker}&metric=all&token=${finnhubApiKey}`),
                        fetch(`https://finnhub.io/api/v1/company-news?symbol=${ticker}&from=${new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]}&to=${new Date().toISOString().split('T')[0]}&token=${finnhubApiKey}`)
                    ]);
                    
                    profileData = await profileResponse.json();
                    quoteData = await quoteResponse.json();
                    metricsData = await metricsResponse.json();
                    newsData = await newsResponse.json();
                }
                
                // Update modal with real data
                if (profileData.name) {
                    document.getElementById('companyName').textContent = profileData.name;
                }
                
                if (quoteData.c && quoteData.pc) {
                    const currentPrice = quoteData.c;
                    const prevClose = quoteData.pc;
                    const change = currentPrice - prevClose;
                    const percentChange = (change / prevClose * 100).toFixed(2);
                    
                    document.getElementById('currentPrice').innerHTML = `$${currentPrice.toFixed(2)} `;
                    if (change >= 0) {
                        document.getElementById('currentPrice').innerHTML += `<span class="price-up">(+${percentChange}%)</span>`;
                    } else {
                        document.getElementById('currentPrice').innerHTML += `<span class="price-down">(${percentChange}%)</span>`;
                    }
                    
                    // Generate more detailed analysis
                    await generateDetailedAnalysis(ticker, currentPrice, prevClose, profileData, metricsData, newsData);
                } else {
                    document.getElementById('currentPrice').textContent = 'Price data unavailable';
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('dataStatus').textContent = 'Error loading real-time data';
            }
            
            // Show modal
            modal.style.display = 'block';
        }
        
        async function generateDetailedAnalysis(ticker, currentPrice, prevClose, profileData, metricsData, newsData) {
            const aiSummary = document.getElementById('aiSummary');
            const metricsList = document.getElementById('keyMetrics');
            const newsSentiment = document.getElementById('newsSentiment');
            const recommendation = document.getElementById('buyRecommendation');
            
            // Calculate basic metrics
            const change = currentPrice - prevClose;
            const percentChange = (change / prevClose * 100).toFixed(2);
            const isPositive = change >= 0;
            
            // Generate summary
            let summaryText = `Our Quantum AI analysis for ${ticker} indicates ${isPositive ? 'positive' : 'negative'} momentum with a ${percentChange}% ${isPositive ? 'increase' : 'decrease'} from previous close. `;
            
            if (metricsData && metricsData.metric) {
                const metrics = metricsData.metric;
                summaryText += `The stock has a ${metrics.roe ? 'strong' : 'moderate'} financial position with `;
                
                if (metrics.pe) {
                    summaryText += `a P/E ratio of ${metrics.pe.toFixed(2)} (${metrics.pe < 15 ? 'undervalued' : metrics.pe < 25 ? 'fairly valued' : 'overvalued'}), `;
                }
                
                if (metrics.week52high && metrics.week52low) {
                    const from52WeekHigh = ((metrics.week52high - currentPrice) / metrics.week52high * 100).toFixed(2);
                    const from52WeekLow = ((currentPrice - metrics.week52low) / metrics.week52low * 100).toFixed(2);
                    summaryText += `trading ${from52WeekHigh}% below 52-week high and ${from52WeekLow}% above 52-week low.`;
                }
                
                // Update key metrics
                metricsList.innerHTML = '';
                if (metrics.week52high && metrics.week52low) {
                    metricsList.innerHTML += `<li>52-Week Range: $${metrics.week52low.toFixed(2)} - $${metrics.week52high.toFixed(2)}</li>`;
                }
                if (metrics.pe) {
                    metricsList.innerHTML += `<li>P/E Ratio: ${metrics.pe.toFixed(2)}</li>`;
                }
                if (profileData.marketCapitalization) {
                    metricsList.innerHTML += `<li>Market Cap: $${(profileData.marketCapitalization / 1000000000).toFixed(2)}B</li>`;
                }
                if (metrics.beta) {
                    metricsList.innerHTML += `<li>Beta: ${metrics.beta.toFixed(2)}</li>`;
                }
            } else {
                // Fallback basic metrics
                metricsList.innerHTML = `
                    <li>Current Price: $${currentPrice.toFixed(2)}</li>
                    <li>Previous Close: $${prevClose.toFixed(2)}</li>
                    <li>Daily Change: ${percentChange}%</li>
                `;
            }
            
            // News sentiment analysis
            if (newsData && newsData.length > 0) {
                const positiveNews = newsData.filter(news => news.sentiment > 0.3).length;
                const negativeNews = newsData.filter(news => news.sentiment < -0.3).length;
                const neutralNews = newsData.length - positiveNews - negativeNews;
                
                const sentimentScore = (positiveNews - negativeNews) / newsData.length;
                
                newsSentiment.innerHTML = `Recent news sentiment: <strong>${sentimentScore > 0.2 ? 'Positive' : sentimentScore < -0.2 ? 'Negative' : 'Neutral'}</strong><br>
                    Positive: ${positiveNews}, Negative: ${negativeNews}, Neutral: ${neutralNews}`;
            } else {
                newsSentiment.textContent = 'No recent news available';
            }
            
            aiSummary.textContent = summaryText;
            
            // Get AI prediction from aimlapi.com
            const aiPrediction = await getAIPrediction(ticker);
            document.getElementById('aiPrediction').innerHTML = `
                <p><strong>AI Market Prediction:</strong> ${aiPrediction}</p>
            `;
            
            // Generate recommendation based on AI prediction and other factors
            let recommendationClass, recommendationText;
            
            if (aiPrediction.toLowerCase().includes('buy') || aiPrediction.toLowerCase().includes('strong buy')) {
                recommendationClass = 'buy-yes';
                recommendationText = 'BUY';
                if (aiPrediction.toLowerCase().includes('strong')) {
                    recommendationText = 'STRONG BUY';
                }
            } else if (aiPrediction.toLowerCase().includes('sell') || aiPrediction.toLowerCase().includes('strong sell')) {
                recommendationClass = 'buy-no';
                recommendationText = 'SELL';
                if (aiPrediction.toLowerCase().includes('strong')) {
                    recommendationText = 'STRONG SELL';
                }
            } else if (isPositive && percentChange > 1) {
                recommendationClass = 'buy-yes';
                recommendationText = 'BUY';
            } else if (isPositive) {
                recommendationClass = 'buy-yes';
                recommendationText = 'WEAK BUY';
            } else if (!isPositive && percentChange < -1) {
                recommendationClass = 'buy-no';
                recommendationText = 'SELL';
            } else {
                recommendationClass = '';
                recommendationText = 'HOLD';
            }
            
            recommendation.className = 'buy-answer ' + recommendationClass;
            recommendation.textContent = recommendationText;
            
            document.getElementById('dataStatus').textContent = `Live data connected (${currentDataSource === 'polygon' ? 'Polygon.io' : 'Finnhub API'})`;
        }
        
        function closeModal() {
            document.getElementById('analysisModal').style.display = 'none';
        }
        
        // Close modal when clicking outside content
        window.onclick = function(event) {
            const modal = document.getElementById('analysisModal');
            if (event.target == modal) {
                closeModal();
            }
        }
        
        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
        
        // Close WebSocket when window is closed
        window.addEventListener('beforeunload', function() {
            if (socket) {
                socket.close();
            }
        });
    </script>
</body>
</html>
